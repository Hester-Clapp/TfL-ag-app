<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenges | TfL-ag</title>
    <link rel="stylesheet" href="/style">
</head>

<body>
    <header>
        <h1>Challenges</h1>
        <a href="/" id="back">&#x2190 Back</a>
    </header>
    <main>
        <!-- <div>
        <h3>Your coins:</h3>
        <textarea readonly id="coins">...</textarea>
    </div>
    <hr> -->
        <p id="message">Fetching location...</p>
        <hr>
        <h2>Nearby:</h2>
        <ul id="loc-challenges" class="challenges">
            Loading challenges...
        </ul>
    </main>
</body>
<script>
    document.querySelector("main").style.width = window.visualViewport.width + "px"

    // Get Location
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (position) => {
                // Check if challenges are open
                document.getElementById("message").innerHTML = `Location last found at ${new Date(position.timestamp).toTimeString().slice(0, 8)}`
                if (![...document.querySelectorAll("button.collapsible")].some(v => v.classList.contains("expanded"))) {
                    // Fetch challenges from server
                    getChallenges(challenges => {

                        challenges.locational.forEach(challenge => { challenge.distance = calculateDistance(position.coords, challenge) })
                        document.getElementById("loc-challenges").innerHTML = ""
                        challenges.locational.filter(v => v.open).sort((a, b) => a.distance - b.distance).forEach(v => {
                            document.getElementById("loc-challenges").innerHTML += `
                        <li>
                            <button class="collapsible">
                                ${formatDistance(v.distance)}<br>
                                <h3>${v.title}</h3>
                                </button>
                                <div style="display: none;">
                                    ${v.description}<br>
                                    <button>Claim ${v.reward} coins</button>
                                </div>
                                </li>
                            `
                        })

                        // Animate Challenge Dropdowns
                        document.querySelectorAll("button.collapsible").forEach(v => {
                            v.addEventListener("click", () => {
                                v.classList.toggle("expanded")
                                v.nextElementSibling.style.display = v.classList.contains("expanded") ? "block" : "none"
                            })
                        })
                    })
                }
            }
        )
    } else {
        document.getElementById("message").innerHTML = "Geolocation not supported."
    }

    const metresPerDegreeEquator = 111120
    function calculateDistance(obj1, obj2) {
        return Math.hypot(obj1.latitude - obj2.latitude, (obj1.longitude - obj2.longitude) * Math.cos((obj1.latitude + obj2.latitude) * 90 / Math.PI)) * metresPerDegreeEquator
    }


    function formatDistance(distance, sigfigs = 2) {
        let digits = Math.floor(Math.log10(distance))
        distance = Math.round(distance * 10 ** (sigfigs - digits - 1)) * 10 ** (digits - sigfigs + 1)
        if (digits < 3) return `${distance}m`
        else return `${distance / 1000}km`
    }

    // Get Challenges
    function getChallenges(callback) {
        fetch("/challenges.json").then(res => res.json().then(callback))
    }
</script>

</html>